<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css" />
    <link rel="stylesheet" href="css/my-grid.css" />
       <script type="application/javascript" src="lib/fontawesome-5.11.2/js/all.min.js"></script>
    <!-- <script src="https://kit.fontawesome.com/70b4df623f.js" crossorigin="anonymous"></script> -->

</head>

<body>
    <header id="header" class="container d-flex justify-content-space-between">
        <div class="h-box-left d-flex">
            <div class="header-left-mb d-none d-md-flex flex-col justify-content-space-between align-items-center">
                <i class="fas fa-info-circle help-icon"></i>
                <span>Ajuda</span>
            </div>
            <div class="header-left d-flex d-md-none align-items-center">
                <i class="fas fa-info-circle help-icon"></i>
                <span>Como Funciona</span>
            </div>
            <div class="header-left d-flex d-md-none align-items-center justify-content-center border">
                <i class="fab fa-whatsapp whatsapp-icon"></i>
                <div>0800 123 2222<br />
                    Envie mensagem ou ligue</div>
            </div>
        </div>
        <div class="header-center">
            <img src="img/quero-bolsa.png">
        </div>
        <div class="h-box-right d-flex d- justify-content-end">
            <div class="header-right-mb d-none d-md-flex flex-col justify-content-space-between align-items-center hide">
                <i class="far fa-user-circle acc-icon"></i>
                <span>Conta</span>
            </div>
            <div class="header-right d-flex d-md-none align-items-center">
                <span>Nome e sobrenome</span>
                <i class="far fa-user-circle acc-icon"></i>
            </div>
        </div>
    </header>
    <div class="sub-header">
        <ul class="container">
            <li class="my-account">Minha Conta</li>
            <li class="my-account d-md-none">Pré Matrículas</li>
            <li class="my-account d-md-none">Bolsas Favoritas</li>
            <li class="menu d-none d-md-block">Menu <i class="fas fa-caret-down"></i></li>
        </ul>
    </div>

    <div class="container navigation">
        <a class="d-md-none"><i class="fas fa-chevron-left d-none d-md-inline"></i> Home /</a>
        <a><i class="fas fa-chevron-left d-none d-md-inline"></i> Minha Conta <span class="d-md-none">/</span></a>
        <a class="d-md-none"> Bolsas Favoritas</a>
    </div>

    <div class="container">
        <div class="top-info">
            <h1>Bolsas Favoritas</h1>
            <h3>Adicione bolsas de cursos e faculdades do seu interesse e receba atualizações com as melhores ofertas disponíveis.</h3>
        </div>

        <div class="semesters">
            <ul class="semester-list">
                <li id="sem0" data-additional-sem="0">Todos os semestres</li>
                <li id="sem2" data-additional-sem="2">2º Semestre</li>
                <li id="sem1" data-additional-sem="1">1º Semestre</li>
            </ul>
        </div>

        <div id="bolsas" class="bolsas d-flex row">
            <div class="col-xs-4 col-lg-3 col-md-2 col-sm-12">
                <div id="myBtn" class="bolsa add-bolsa flex-item">
                    <i class="fas fa-plus-circle plus-icon"></i>
                    <div class="text">
                        <h1>Adicionar bolsa</h1>
                        <p>Clique para adicionar bolsas de cursos do seu interesse</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="f-top d-none d-md-flex align-items-center justify-content-center">
            <i class="fab fa-whatsapp whatsapp-icon"></i>
            <div><span>0800 123 2222</span><br />
                Segunda a sexta de 8h às 22h</div>
        </div>


        <div class="f-bottom d-none d-md-flex">
            <div class="chat flex-1">
                <i class="far fa-comments f-icon"></i>
                <p>
                    Chat
                </p>
            </div>
            <div class="email flex-1">
                <i class="far fa-envelope f-icon"></i>
                <p>
                    E-mail
                </p>
            </div>
            <div class="help flex-1">
                <i class="fas fa-info-circle f-icon"></i>
                <p>
                    Ajuda
                </p>
            </div>
        </div>

        <div class="f-bottom d-md-none d-flex">
            <div class="d-flex flex-1 align-items-center justify-content-center">
                <i class="fab fa-whatsapp whatsapp-icon f-icon"></i>
                <div><span>0800 123 2222</span><br />
                    Seg - Sex 8h-22h</div>
            </div>
            <div class="d-flex flex-1 align-items-center justify-content-center">
                <i class="far fa-comments f-icon"></i>
                <div><span>Chat ao vivo</span><br />
                    Seg - Sex 8h-22h</div>
            </div>
            <div class="d-flex flex-1 align-items-center justify-content-center">
                <i class="far fa-envelope f-icon"></i>
                <div><span>Mande um email</span><br />
                    Respondemos rapidinho</div>
            </div>
            <div class="d-flex flex-1 align-items-center justify-content-center">
                <i class="fas fa-info-circle f-icon"></i>
                <div><span>Central de ajuda</span><br />
                    Encontre todas as respostas</div>
            </div>
        </div>
        <div class="f-end">
            <p>
                Feito com <i class="far fa-heart"></i> pela Quero Educação
            </p>
        </div>
    </footer>


    <!-- The Modal -->
    <div id="adicionar-bolsa-modal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Adicionar bolsa</h2>
            <p>Filtre e adicione as bolsas de seu interesse.</p>

            <form class="hz-form form-bolsa">
                <div class="form-group d-flex justify-content-space-between top-filter">
                    <div class="input">
                        <label>Selecione sua cidade</label>
                        <select id="filter-city">
                            <option value="" selected>Cidade</option>
                        </select>
                    </div>
                    <div class="input">
                        <label>Selecione o curso de sua preferência</label>
                        <select id="filter-course">
                            <option value="" selected>Curso</option>
                        </select>
                    </div>
                </div>

                <div class="filter form-group d-flex justify-content-space-between">
                    <div class="input">
                        <h4>Como você pretende estudar?</h4>
                        <br>
                        <label class="cbx-container">
                            <input type="checkbox" id="filter-presential" name="">
                            <span class="checkmark"></span>
                            Presencial
                        </label>
                        <label class="cbx-container">
                            <input type="checkbox" id="filter-distance" name="">
                            <span class="checkmark"></span>
                        A distância
                        </label>
                    </div>
                    <div class="input">
                        <h4>Até quanto pode pagar?</h4>
                        <p>R$ <span id="slider-display"></span></p>
                        <input type="range" class="slider" id="filter-price" name="points" min="50" max="2000">
                    </div>
                </div>
            </form>

            <div class="list-header d-flex justify-content-space-between">
                Resultados
                <h4><span class="sort">Ordenar por</span> <span id="filter-order">Nome da Faculdade<i class="fas fa-caret-down" style="margin-left: 5px"></i></span></h4>
            </div>
            <div class="results" id="course-list">
                <div class="result d-flex align-items-center">
                    <div class="option d-flex flex-1 align-items-center">
                        <input type="checkbox" name="">
                        <img src="img/quero-bolsa.png">
                    </div>
                    <div class="description flex-3">
                        <div class="d-flex justify-content-space-between">
                            <div class="info">
                                <h4>Administração</h4>
                                <p>Bacharelado</p>
                            </div>
                            <div class="values">
                                <p>Bolsa de</p>
                                <p>R$ 374,00 /mês</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="options">
                <button id="btn-delete-modal" class="btn-delete">Cancelar</button>
                <button id="btn-add-bolsas" class="btn-see-offer" disabled="disabled">Adicionar bolsa(s)</button>
            </div>

        </div>

    </div>

    <script>
    /* FILTROS JS */

    var city_filter = document.getElementById("filter-city");
    city_filter.addEventListener("change", function(evt){filter(evt, "city")}, false);

    var course_filter = document.getElementById("filter-course");
    course_filter.addEventListener("change", function(evt){filter(evt, "course")}, false);

    var presential_filter = document.getElementById("filter-presential");
    presential_filter.addEventListener("change", function(evt){filter(evt, "presential")}, false);

    var distance_filter = document.getElementById("filter-distance");
    distance_filter.addEventListener("change", function(evt){filter(evt, "distance")}, false);

    var btn_add_bolsas = document.getElementById("btn-add-bolsas");
    btn_add_bolsas.addEventListener("click", function(evt){confirmAddBolsas()}, false);

    var order_filter = document.getElementById("filter-order");
    order_filter.addEventListener("click", function(evt){orderByUniversityName()}, false);

    var btn_delete_modal = document.getElementById("btn-delete-modal");
    btn_delete_modal.addEventListener("click", function(evt){ span.click()}, false);

    var slider = document.getElementById("filter-price");
    var output = document.getElementById("slider-display");

    var order_by_university_name = false;

    var slider_value = slider.value;
    output.innerHTML = slider_value;

    /* CAPTURANDO EVENTO SLIDER */
    slider.oninput = function() {
        slider_value = this.value;
        output.innerHTML = slider_value;
      filter();
    }

    /* ADICIONANDO LISTENER PARA OS BOTÕES DE FILTRAGEM DE SEMESTRE */
    document.querySelectorAll("ul.semester-list li")
        .forEach(function(elm) {
            console.log(elm.dataset.additionalSem);
            let semester = elm.dataset.additionalSem;
            elm.addEventListener("click", function(evt){filterSemester(semester)}, false);

          })

    /* DEFINIÇÕES DE FILTRO NA BUSCA POR BOLSAS MODAL*/
    function filter() {
        console.log('filter go go');
        selected_courses = [];

        selected_city = city_filter.options[city_filter.selectedIndex].value;
        selected_course = course_filter.options[course_filter.selectedIndex].value;

        courses_filtered = courses_data;

        if(selected_city != "") {

            console.log("CITY FILTER", selected_city);

            courses_filtered = courses_filtered.filter(function (course) {
              return course.campus.city == selected_city;
            });
        }

        if(selected_course != "") {
            console.log("COURSE FILTER", selected_course);

            courses_filtered = courses_filtered.filter(function (course) {
              return course.course.name == selected_course;
            });
        }

        if(presential_filter.checked && !distance_filter.checked){
            console.log("PRESENTIAL FILTER");
            courses_filtered = courses_filtered.filter(function (course) {
              return course.course.kind == "Presencial";
            });
        }
        else if(distance_filter.checked && !presential_filter.checked){
            console.log("DISTANCE FILTER");
            courses_filtered = courses_filtered.filter(function (course) {
              return course.course.kind == "EaD";
            });
        }

        courses_filtered = courses_filtered.filter(function (course) {
          return course.price_with_discount <= slider_value;
        });

        console.log(courses_filtered);
        populateCoursesList(courses_filtered);


    }

    /* ORDENANDO LISTAGEM DE BOLSAS POR UNIVERSIDADE */
    function orderByUniversityName() {

        var order_icon = order_filter.childNodes[1].classList;

        if(!order_by_university_name) {
            courses_filtered = courses_filtered.sort(function(a,b){ return a.university.name.localeCompare(b.university.name);})
            order_icon.remove("fa-caret-down");
            order_icon.add("fa-caret-up");
            order_by_university_name = true;
        } else {
            courses_filtered = courses_filtered.sort(function(a,b){ return b.university.name.localeCompare(a.university.name);})
            order_icon.remove("fa-caret-up");
            order_icon.add("fa-caret-down");
            order_by_university_name = false;
        }
        populateCoursesList(courses_filtered);
    }

    /* CONFIRMANDO A ADIÇÃO DA BOLSA SELECIONADA */
    function confirmAddBolsas() {
        console.log("CONFIRMANDO", selected_courses);
        localStorageData(selected_courses, "my-courses");
        filterSemester(0, true);

        document.querySelectorAll("input.bolsa-check-list").forEach(function(elm) {
            elm.checked = false;
        })

        document.getElementById("btn-add-bolsas").disabled = true;

        // Fechando modal
        span.click();
    }

    /* REMOVENDO BOLSA */
    function rmBolsa(evt) {
        console.log(evt.target.dataset.additionalId);
        var id = evt.target.dataset.additionalId;

        current_courses = localStorageRemove(id, "my-courses");
        evt.target.parentElement.parentElement.parentElement.hidden = true;
    }

    /* VERIFICANDO E PERSISTINDO DADOS NO BROWSER */
    function localStorageData(data, name) {
        if(!localStorage.getItem(name)) {
            localStorage.setItem(name, JSON.stringify(data));
        } else {
            var course_obj = JSON.parse(localStorage.getItem(name));
            course_obj = course_obj.concat(data);
            localStorage.setItem(name, JSON.stringify(course_obj));
        }
    }

    /* REMOVENDO DADOS DO BROWSER */
    function localStorageRemove(id, name) {
            var courses_obj = JSON.parse(localStorage.getItem(name));
            courses_obj = courses_obj.filter(function(el) { return el.id != id; })

            localStorage.removeItem(name);
            localStorageData(courses_obj, name);

            return courses_obj;

    }

    /* FILTRANDO SEMESTRES */
    var current_semester;
    function filterSemester(semester, refresh = false) {

        if((semester != current_semester) || refresh) {
            let courses = initializeMyCourses();

            if(semester == 0) {
                populateCourses(courses);
            } else {
                courses = courses.filter(function(el) { return el.enrollment_semester.split(".")[1] == semester; });
                populateCourses(courses);
            }

            document.querySelectorAll("ul.semester-list li").forEach(function(elm) {
                elm.classList.remove("semester-active");
            });

            document.querySelector("#sem" + semester).classList.add("semester-active");

            current_semester = semester;
            console.log("SEMESTER", courses);
            console.log("SEMESTER NUM", semester);
        }
    }

    </script>


    <script type="text/javascript">
        // Get the modal
        var modal = document.getElementById("adicionar-bolsa-modal");

        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on the button, open the modal
        btn.onclick = function() {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        var curso_list =
        `<div class="result d-flex align-items-center">
            <div class="option d-flex flex-1 align-items-center">
                <label class="cbx-container">
                    <input class="bolsa-check-list" type="checkbox" name="" data-additional-id="">
                    <span class="checkmark"></span>
                </label>
                <img class="bolsa-img-list" src="img/quero-bolsa.png">
            </div>
            <div class="description flex-3">
                <div class="d-flex justify-content-space-between">
                    <div class="info">
                        <h4 class="bolsa-title-list"></h4>
                        <p class="bolsa-level-list"></p>
                    </div>
                    <div class="values">
                        <p>Bolsa de <span class="bolsa-disc-list"></span></p>
                        <p class="bolsa-value-all">R$ <span class="bolsa-value-list"></span> /mês</p>
                    </div>
                </div>
            </div>
        </div>`;

        var curso =
            `<div class="col-12 col-xs-4 col-lg-3 col-md-2 col-sm-12 bolsa-item">
            <div class="bolsa flex-item">
                <div class="curso-img">
                    <img class="bolsa-img" src="https://www.tryimg.com/u/2019/04/16/unip.png">
                </div>
                <div class="text">
                    <h3 class="bolsa-title">Anhanguera</h3>
                    <h3 class="bolsa-description">Engenharia da Computação</h3>
                    <p class="bolsa-score">
                        <span class="number">5</span>
                        <span class="stars">
                        </span>
                    </p>
                </div>
                <div class="box-type">
                    <h3 class="bolsa-tipo">Presencial - Noite</h3>
                    <p>Início das aulas em: <span class="bolsa-inicio">10/10/2010</span></p>
                </div>
                <div class="box-monthly">
                    <h4>Mensalidade com o Quero Bolsa:</h4>
                    <p class="bolsa-preco-total"></p>
                    <span class="bolsa-preco"></span>
                    <span>/mês</span>
                </div>
                <div class="options">
                    <button class="btn-delete btn-delete-bolsa" data-additional-id="">Excluir</button>
                    <button class="btn-see-offer">Ver Oferta</button>
                </div>
            </div>
            </div>`;

        var star = '<i class="fas fa-star bolsa-score"></i>';
        var half_star = '<i class="fas fa-star-half-alt bolsa-score"></i>';
        var blank_star = '<i class="far fa-star"></i>';
        var courses_data;
        var courses_filtered;

        const URL_TO_FETCH = 'https://testapi.io/api/redealumni/scholarships';

        fetch(URL_TO_FETCH, {
                method: 'get' // opcional
            })
            .then(response => response.json()) // retorna uma promise
            .then(result => {

                courses_data = result;
                courses_filtered = courses_data;

                result.forEach(function(item, i) {
                    item.id = i;
                })

                console.log(result);

                initializeCityFilter(result);
                initializeCoursesFilter(result) ;
                populateCoursesList(result);

            })
            .catch(err => {
                console.error('Failed retrieving information', err);
            });

        function populateCourses(courses) {

            var coursesElm = document.getElementById("bolsas");
            coursesElm.querySelectorAll(".bolsa-item").forEach(function(elm) {
                elm.remove()
            })


            courses.forEach(function(course) {

                    var elm = htmlToElement(curso);

                    elm.getElementsByClassName('bolsa-title')[0].textContent = course.university.name;
                    elm.getElementsByClassName('bolsa-description')[0].textContent = course.course.name;
                    elm.getElementsByClassName('bolsa-img')[0].src = course.university.logo_url;
                    elm.getElementsByClassName('bolsa-inicio')[0].textContent = course.start_date;
                    elm.getElementsByClassName('bolsa-preco-total')[0].textContent = "R$ " + course.full_price;
                    elm.getElementsByClassName('bolsa-preco')[0].textContent = "R$ " + course.price_with_discount;
                    elm.getElementsByClassName('btn-delete-bolsa')[0].dataset.additionalId = course.id;
                    elm.getElementsByClassName('number')[0].textContent = course.university.score;
                    setScoreElm(elm.getElementsByClassName('stars')[0], course.university.score);
                    coursesElm.append(elm);

                    elm.getElementsByClassName('btn-delete-bolsa')[0].addEventListener("click", function(evt) {
                                  rmBolsa(evt);
                                  console.log("CALL REMOVE BOlsa");
                    });
            });
        }


        function populateCoursesList(courses) {

            var coursesListElm = document.getElementById("course-list");
            coursesListElm.innerHTML = "";


            courses.forEach(function(course, i) {

                    var elm = htmlToElement(curso_list);

                    elm.getElementsByClassName('bolsa-title-list')[0].textContent = course.course.name;
                    elm.getElementsByClassName('bolsa-check-list')[0].dataset.additionalId = course.id;
                    elm.getElementsByClassName('bolsa-level-list')[0].textContent = course.course.level;
                    elm.getElementsByClassName('bolsa-disc-list')[0].textContent = course.discount_percentage + "%";
                    elm.getElementsByClassName('bolsa-value-list')[0].textContent = Math.floor(course.price_with_discount);
                    elm.getElementsByClassName('bolsa-img-list')[0].src = course.university.logo_url;

                    elm.querySelector("input").addEventListener("click", function(evt) {
                                  addBolsas(evt);
                                  console.log("CALL");
                    });

                    coursesListElm.append(elm);

            });
        }

        /* ADICIONAR BOLSAS - CLICK CHECKBOX */
        var selected_courses = [];
        function addBolsas(evt) {
            console.log("ADD BOLSAS CALL");

            var operation = evt.target.checked;
            var bolsa_id = evt.target.dataset.additionalId;

            console.log(evt.target.dataset.additionalId);
            console.log(evt.target.checked);

            // checando se a bolsa será adicionada ou removida
            if(operation) {
                console.log(courses_data[bolsa_id]);
                selected_courses.push(courses_data[bolsa_id]);
            } else {
                selected_courses = selected_courses.filter(function(el) { return el.id != bolsa_id; })
            }

            // habilitando botão para add bolsa se houverem itens selecionados
            if(!selected_courses.length > 0)
                document.getElementById("btn-add-bolsas").disabled = true;
            else
                document.getElementById("btn-add-bolsas").disabled = false;

            console.log("SELECTED ", selected_courses);

        }

        function initializeCityFilter(itens) {
            var x = document.getElementById("filter-city");

            var cities = itens.map(function(elm) {
                return elm.campus.city;
            })

            var distinctCities = [...new Set(cities)];
            console.log(distinctCities);

            distinctCities.forEach(function(item) {
                var option = document.createElement("option");

                option.text = item;
                option.value = item;
                x.add(option);
            })
        }

        function initializeCoursesFilter(itens) {
            var x = document.getElementById("filter-course");

            var courses = itens.map(function(elm) {
                return elm.course.name;
            })

            var distinctCourses = [...new Set(courses)];
            console.log(distinctCourses);

            distinctCourses.forEach(function(item) {
                var option = document.createElement("option");

                option.text = item;
                option.value = item;
                x.add(option);
            })
        }

        function initializeMyCourses() {
            if(courses_local = localStorage.getItem("my-courses")) {
                return JSON.parse(courses_local).reverse();
            } else {
                return [];
            }
        };

        function htmlToElement(html) {
            var template = document.createElement('template');
            html = html.trim(); // Never return a text node of whitespace as the result
            template.innerHTML = html;
            return template.content.firstChild;
        }

        function htmlToElements(html) {
            var template = document.createElement('template');
            template.innerHTML = html;
            return template.content.childNodes;
        }

        function setScoreElm(elm, score) {

            for (i = 1; i < 6; i++) {

                if (Math.floor(score) > i - 1) {
                    elm.append(htmlToElement(star));
                } else if (Math.floor(score) == i - 1) {
                    console.log("score == score");
                    if (score - Math.floor(score) > .5) {
                        elm.append(htmlToElement(half_star));
                    } else {
                        elm.append(htmlToElement(blank_star));
                    }
                } else {
                    elm.append(htmlToElement(blank_star));
                }

            }
        }

        /* INÍCIO LISTAGEM CURSOS ESCOLHIDOS PELO USUÁRIO */
        filterSemester(0);

    </script>




</body></html>
